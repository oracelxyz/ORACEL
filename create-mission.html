<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>ORACEL – Create Mission</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Inter:wght@400;500&display=swap" rel="stylesheet">

<style>
body { font-family: 'Inter', sans-serif; }
h1,h2,h3 { font-family: 'Space Grotesk', sans-serif; }
</style>
</head>

<body class="text-white overflow-x-hidden">

<div class="fixed inset-0 -z-10">
  <div class="absolute inset-0 bg-gradient-to-br from-[#040817] via-[#0A1440] to-[#020617]"></div>
  <div class="absolute inset-0 opacity-[0.25] bg-[url('https://grainy-gradients.vercel.app/noise.svg')]"></div>
</div>

<div class="flex min-h-screen">

  <!-- SIDEBAR -->
  <aside class="w-64 bg-black/40 backdrop-blur-xl border-r border-blue-400/20 hidden md:flex flex-col justify-between">
    <div>
      <div class="p-6 flex items-center gap-3">
        <img src="logo-oracel.png" class="w-9 h-9 rounded-lg">
        <span class="text-lg font-semibold tracking-widest text-blue-400">ORACEL</span>
      </div>
      <nav class="px-4 space-y-1 text-sm">
        <a href="index.html" class="flex px-4 py-3 rounded-xl hover:bg-blue-500/10">Overview</a>
        <a href="earn.html" class="flex px-4 py-3 rounded-xl hover:bg-blue-500/10">Earn</a>
        <a class="flex px-4 py-3 rounded-xl bg-blue-500/10 text-blue-400">Create Mission</a>
        <a href="badge.html" class="flex px-4 py-3 rounded-xl hover:bg-blue-500/10">Badge</a>
        <a href="leaderboard.html" class="flex px-4 py-3 rounded-xl hover:bg-blue-500/10">Leaderboard</a>
        <a class="flex px-4 py-3 rounded-xl opacity-50 cursor-not-allowed">Claim (Soon)</a>
        <a href="wallet.html" class="flex px-4 py-3 rounded-xl hover:bg-blue-500/10">Wallet</a>
        <a href="profile.html" class="flex px-4 py-3 rounded-xl hover:bg-blue-500/10">Profile</a>
        <a href="raffle.html" class="flex px-4 py-3 rounded-xl hover:bg-blue-500/10">Raffle</a>
      </nav>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="flex-1 p-6 space-y-10">

    <header class="flex justify-between items-center">
      <h1 class="text-2xl font-semibold tracking-wide">
        Create Premium Mission
      </h1>
      <span id="walletStatus" class="text-xs tracking-widest text-blue-300/70 uppercase">
        Wallet Not Connected
      </span>
    </header>

    <section class="max-w-4xl mx-auto bg-white/5 backdrop-blur-xl
      rounded-3xl border border-blue-400/30 p-8">

      <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-semibold">Premium Mission Access</h2>
        <div class="text-right">
          <div class="text-xs text-gray-400">Price</div>
          <div id="missionPrice" class="text-2xl font-bold text-blue-400">0.15 SOL</div>
        </div>
      </div>

      <div class="space-y-4 mb-8">
        <label class="text-sm text-gray-300">X Post URL (Mission Target)</label>
        <input
          id="missionUrl"
          type="text"
          placeholder="https://x.com/username/status/..."
          class="w-full px-4 py-3 rounded-xl bg-black/50 border border-blue-400/20
          focus:outline-none focus:border-blue-400 text-sm">
        <p class="text-xs text-gray-500">Mission includes: Like • Comment • Repost (Auto)</p>
      </div>

      <button
        id="createMissionBtn"
        class="w-full py-4 rounded-2xl bg-blue-500 hover:bg-blue-400
        text-black font-semibold tracking-wide transition">
        Pay with SOL & Create Mission
      </button>

      <p class="text-xs text-center text-gray-500 mt-4">
        Premium mission will be active for 6 hours after creation.
      </p>
    </section>

  </main>
</div>

<script type="module">
import { app, auth, db } from './firebase.js';
import { doc, setDoc, getDoc, updateDoc, arrayUnion, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

let walletAddress = null;
const projectWallet = "A7EENCL16mwnzhZa5XhmCPhKTVhX2S7X5hcVpBGz83r8"; // Project SOL wallet

async function connectWallet() {
  if (!window.solana) return alert("No Solana wallet detected!");
  const resp = await window.solana.connect();
  walletAddress = resp.publicKey.toString();
  document.getElementById("walletStatus").innerText = walletAddress.slice(0,6) + "..." + walletAddress.slice(-4);

  // Get Firebase custom token
  const customToken = await fetch(`/api/getCustomToken?wallet=${walletAddress}`).then(r => r.text());
  await signInWithCustomToken(auth, customToken);

  // Create user if not exists
  const userRef = doc(db, "users", walletAddress);
  const userSnap = await getDoc(userRef);
  if (!userSnap.exists()) {
    await setDoc(userRef, {
      wallet: walletAddress,
      createdAt: serverTimestamp(),
      points: 0,
      ocePremium: 0,
      ocePoints: 0,
      badges: [],
    });
  }
}

document.getElementById("createMissionBtn").onclick = async () => {
  const url = document.getElementById("missionUrl").value;
  if (!walletAddress) return alert("Connect your wallet first");
  if (!url) return alert("Enter mission URL");

  // Debit project wallet (simulated, implement real Solana transaction in backend)
  console.log(`User ${walletAddress} paid 0.15 SOL to project wallet ${projectWallet}`);

  // Update user OCE Premium token & points
  const userRef = doc(db, "users", walletAddress);
  await updateDoc(userRef, {
    ocePremium: (await getDoc(userRef)).data().ocePremium + 1,
    ocePoints: (await getDoc(userRef)).data().ocePoints + 100, // example reward
  });

  // Store mission in Firestore
  const missionId = "mission_" + Date.now();
  const missionRef = doc(db, "missions", missionId);
  await setDoc(missionRef, {
    id: missionId,
    creator: walletAddress,
    url,
    rewardPoints: 100,
    status: "active",
    createdAt: serverTimestamp(),
    expiresAt: Date.now() + 6*60*60*1000 // 6 hours later
  });

  alert("Mission created! Premium token and points added.");
  document.getElementById("missionUrl").value = "";
}

// Auto connect if wallet already available
onAuthStateChanged(auth, async (user) => {
  if (user) {
    walletAddress = user.uid;
    document.getElementById("walletStatus").innerText = walletAddress.slice(0,6) + "..." + walletAddress.slice(-4);
  }
});

// Connect wallet on page load
window.addEventListener("load", connectWallet);
</script>

<script type="module" src="firebase.js"></script>
</body>
</html>